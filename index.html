<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>YardStick PRO - Precision Estimator</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#166534">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        #map { height: 60vh; width: 100%; z-index: 1; transition: height 0.3s ease; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .material-btn.active { background-color: #15803d; color: white; border-color: #15803d; transform: scale(1.05); }
        .search-container { position: absolute; top: 75px; left: 10px; right: 10px; z-index: 1000; }
        
        .map-actions {
            position: absolute;
            right: 12px;
            top: 140px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .map-tool-btn {
            background: rgba(255, 255, 255, 0.95);
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: #1e293b;
            transition: all 0.2s;
        }
        .map-tool-btn.active-mode { background: #ef4444; color: white; }
        
        /* Precision Crosshair */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin-top: -15px;
            margin-left: -15px;
            z-index: 1001;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 2px black;
        }
        .crosshair::before { width: 1px; height: 100%; }
        .crosshair::after { height: 1px; width: 100%; }
        .center-dot { width: 4px; height: 4px; background: #10b981; border-radius: 50%; border: 1px solid white; z-index: 2;}

        /* Drop Pin UI */
        .drop-pin-trigger {
            position: absolute;
            bottom: 42%;
            right: 12px;
            z-index: 1001;
        }
        .drop-btn {
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 12px;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <div class="bg-green-900 text-white p-3 pt-8 shadow-md flex justify-between items-center z-50">
        <div>
            <h1 class="text-lg font-black tracking-tight leading-none">YardStick PRO</h1>
            <span class="text-[9px] uppercase tracking-widest opacity-60">High Resolution Precision</span>
        </div>
        <div class="flex items-center space-x-3">
            <div id="gps-indicator" class="h-3 w-3 rounded-full bg-red-500"></div>
            <button id="undo-btn" class="bg-white/10 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase">Undo Pin</button>
        </div>
    </div>

    <!-- Search -->
    <div class="search-container">
        <div class="flex shadow-2xl rounded-xl overflow-hidden border border-gray-200">
            <input type="text" id="address-input" placeholder="Enter Property Address..." class="flex-1 p-3 outline-none text-sm font-medium bg-white/95">
            <button id="search-btn" class="bg-green-700 text-white px-5 font-bold text-sm">Find</button>
        </div>
    </div>

    <!-- Map Viewport -->
    <div class="relative flex-1">
        <div id="map"></div>
        
        <!-- Precision Targeting -->
        <div class="crosshair">
            <div class="center-dot"></div>
        </div>

        <div class="drop-pin-trigger">
            <button id="manual-drop-btn" class="drop-btn active:scale-90 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                DROP PIN
            </button>
        </div>

        <div class="map-actions">
            <button id="capture-view-btn" class="map-tool-btn" title="Fit to View">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
            </button>
            <button id="deduct-mode-btn" class="map-tool-btn" title="Subtract Area">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            </button>
            <button id="clear-map-btn" class="map-tool-btn text-red-600" title="Clear All">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
        </div>
    </div>

    <!-- Stats Sheet -->
    <div class="bg-white shadow-[0_-10px_30px_rgba(0,0,0,0.15)] z-50 overflow-y-auto rounded-t-[2.5rem] p-5">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                <span class="text-[9px] font-black uppercase text-emerald-700 block mb-1">Net Coverage</span>
                <div class="flex items-baseline">
                    <span id="area-display" class="text-2xl font-mono font-black text-emerald-900">0.0</span>
                    <span class="text-[10px] font-bold text-emerald-700 ml-1">SQ FT</span>
                </div>
            </div>
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <span class="text-[9px] font-black uppercase text-blue-700 block mb-1">Cubic Volume</span>
                <div class="flex items-baseline">
                    <span id="volume-display" class="text-2xl font-mono font-black text-blue-900">0.00</span>
                    <span class="text-[10px] font-bold text-blue-700 ml-1">YD³</span>
                </div>
            </div>
        </div>

        <div class="bg-slate-900 p-4 rounded-2xl flex justify-between items-center mb-6">
            <div>
                <span class="text-[9px] font-black uppercase text-slate-400 block mb-1">Est. Total</span>
                <span id="cost-display" class="text-2xl font-mono font-black text-white">$0.00</span>
            </div>
            <div class="text-right">
                <span id="depth-label" class="text-emerald-400 font-black text-sm block">3.0" Depth</span>
                <span id="mat-name-display" class="text-slate-400 text-[9px] uppercase font-bold tracking-widest">Mulch</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <button id="save-btn" class="bg-green-700 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95">SAVE PROJECT</button>
            <button id="history-toggle" class="bg-slate-100 border text-slate-700 font-black py-4 rounded-2xl active:scale-95">HISTORY</button>
        </div>

        <div id="history-container" class="hidden pb-10">
            <div id="history-list" class="history-panel space-y-2"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, mainPolygon, cutoutPolygon;
        let points = [], markers = [];
        let cutoutPoints = [], cutoutMarkers = [];
        let isDeductMode = false;
        let jobs = JSON.parse(localStorage.getItem('yardstick_jobs') || '[]');

        function initMap() {
            // Enhanced zoom settings - maxZoom 22
            map = L.map('map', { 
                zoomControl: false, 
                attributionControl: false, 
                maxZoom: 22,
                wheelPxPerZoomLevel: 60
            }).setView([30.3322, -81.6557], 19);
            
            // High Resolution Imagery
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
                maxZoom: 22,
                maxNativeZoom: 19 // Upscales for detail past level 19
            }).addTo(map);

            // Street Labels
            L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}{r}.png', { 
                subdomains: 'abcd', 
                maxZoom: 22, 
                opacity: 0.5 
            }).addTo(map);

            L.control.scale({position: 'bottomleft', imperial: true, metric: false}).addTo(map);

            map.locate({setView: true, maxZoom: 20});
            renderHistory();
        }

        function dropPinAtCenter() {
            const center = map.getCenter();
            addPoint(center.lat, center.lng);
        }

        function addPoint(lat, lng) {
            if (isDeductMode) {
                cutoutPoints.push([lng, lat]);
                const marker = L.circleMarker([lat, lng], { radius: 5, fillColor: "#ef4444", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map);
                cutoutMarkers.push(marker);
            } else {
                points.push([lng, lat]);
                const marker = L.circleMarker([lat, lng], { radius: 6, fillColor: "#10b981", color: "#fff", weight: 3, fillOpacity: 1 }).addTo(map);
                markers.push(marker);
            }
            updateShape();
        }

        function updateShape() {
            if (mainPolygon) map.removeLayer(mainPolygon);
            if (cutoutPolygon) map.removeLayer(cutoutPolygon);
            
            let totalArea = 0;
            let deductionArea = 0;

            if (points.length >= 3) {
                const poly = turf.polygon([[...points, points[0]]]);
                totalArea = turf.area(poly) * 10.7639;
                mainPolygon = L.polygon(points.map(p => [p[1], p[0]]), { color: '#10b981', fillColor: '#10b981', fillOpacity: 0.35, weight: 3 }).addTo(map);
            }

            if (cutoutPoints.length >= 3) {
                const polyC = turf.polygon([[...cutoutPoints, cutoutPoints[0]]]);
                deductionArea = turf.area(polyC) * 10.7639;
                cutoutPolygon = L.polygon(cutoutPoints.map(p => [p[1], p[0]]), { color: '#ef4444', fillColor: '#ef4444', fillOpacity: 0.5, weight: 2, dashArray: '5,5' }).addTo(map);
            }

            const netArea = Math.max(0, totalArea - deductionArea);
            document.getElementById('area-display').innerText = netArea.toLocaleString(undefined, {maximumFractionDigits: 1});
            
            const cubicYards = (netArea * (3 / 12)) / 27; // Defaulting to 3" for simple display
            document.getElementById('volume-display').innerText = cubicYards.toFixed(2);
            document.getElementById('cost-display').innerText = '$' + (cubicYards * 45).toLocaleString(undefined, {minimumFractionDigits: 2});
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = jobs.length === 0 ? '<p class="text-slate-400 text-center py-4 text-xs">No saved measurements.</p>' : '';
            jobs.forEach(job => {
                const div = document.createElement('div');
                div.className = "p-3 bg-slate-50 border rounded-xl flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex-1" onclick="restoreJob(${job.id})">
                        <h4 class="font-bold text-xs truncate w-32">${job.name}</h4>
                        <p class="text-[10px] text-slate-500">${job.area} ft² • ${job.cost}</p>
                    </div>
                    <button onclick="deleteJob(${job.id})" class="text-slate-300 px-2">✕</button>
                `;
                list.appendChild(div);
            });
        }

        window.deleteJob = (id) => {
            jobs = jobs.filter(j => j.id !== id);
            localStorage.setItem('yardstick_jobs', JSON.stringify(jobs));
            renderHistory();
        };

        document.getElementById('manual-drop-btn').addEventListener('click', dropPinAtCenter);
        document.getElementById('undo-btn').addEventListener('click', () => {
            if (isDeductMode && cutoutPoints.length > 0) {
                cutoutPoints.pop();
                map.removeLayer(cutoutMarkers.pop());
            } else if (!isDeductMode && points.length > 0) {
                points.pop();
                map.removeLayer(markers.pop());
            }
            updateShape();
        });

        document.getElementById('deduct-mode-btn').addEventListener('click', function() {
            isDeductMode = !isDeductMode;
            this.classList.toggle('active-mode');
        });

        document.getElementById('clear-map-btn').addEventListener('click', () => {
            points = []; markers.forEach(m => map.removeLayer(m)); markers = [];
            cutoutPoints = []; cutoutMarkers.forEach(m => map.removeLayer(m)); cutoutMarkers = [];
            updateShape();
        });

        document.getElementById('search-btn').addEventListener('click', async () => {
            const query = document.getElementById('address-input').value;
            if(!query) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if(data.length > 0) map.setView([data[0].lat, data[0].lon], 20);
            } catch (e) { console.error(e); }
        });

        document.getElementById('history-toggle').addEventListener('click', () => {
            document.getElementById('history-container').classList.toggle('hidden');
        });

        window.onload = initMap;
    </script>
</body>
</html>

