<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>YardStick PRO - Precision Estimator</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#166534">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        #map { height: 65vh; width: 100%; z-index: 1; transition: height 0.3s ease; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .material-btn.active { background-color: #15803d; color: white; border-color: #15803d; transform: scale(1.05); }
        .search-container { position: absolute; top: 75px; left: 10px; right: 10px; z-index: 1000; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .history-panel { max-height: 25vh; overflow-y: auto; }
        
        /* Custom scrollbar for a cleaner look */
        .history-panel::-webkit-scrollbar { width: 4px; }
        .history-panel::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <div class="bg-green-900 text-white p-3 pt-8 shadow-md flex justify-between items-center z-50">
        <div>
            <h1 class="text-lg font-black tracking-tight leading-none">YardStick PRO</h1>
            <span class="text-[9px] uppercase tracking-widest opacity-60">Professional Grade</span>
        </div>
        <div class="flex items-center space-x-3">
            <div id="gps-indicator" class="h-3 w-3 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]"></div>
            <button id="undo-btn" class="bg-white/10 active:bg-white/30 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-colors">Undo Pin</button>
        </div>
    </div>

    <!-- Search Bar Overlay -->
    <div class="search-container">
        <div class="flex shadow-2xl rounded-xl overflow-hidden border border-gray-200">
            <input type="text" id="address-input" placeholder="Search address or neighborhood..." 
                   class="flex-1 p-3 outline-none text-sm font-medium bg-white/95 backdrop-blur-md">
            <button id="search-btn" class="bg-green-700 text-white px-5 font-bold text-sm active:bg-green-800 transition-colors">Find</button>
        </div>
    </div>

    <!-- Map Area -->
    <div id="map"></div>

    <!-- Bottom Controls Sheet -->
    <div class="flex-1 bg-white shadow-[0_-10px_30px_rgba(0,0,0,0.15)] z-50 overflow-y-auto rounded-t-[2.5rem] border-t border-gray-100">
        <!-- Pull Handle Indicator -->
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mt-3 mb-1"></div>
        
        <div class="p-5 space-y-5">
            
            <!-- Quick Material Selection -->
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setMaterial('Mulch', 3, 45)" class="material-btn active border border-gray-200 py-2.5 rounded-xl text-[11px] font-black uppercase transition-all" id="btn-mulch">Mulch</button>
                <button onclick="setMaterial('Sod', 1, 350)" class="material-btn border border-gray-200 py-2.5 rounded-xl text-[11px] font-black uppercase transition-all" id="btn-sod">Sod</button>
                <button onclick="setMaterial('Dirt/Rock', 4, 65)" class="material-btn border border-gray-200 py-2.5 rounded-xl text-[11px] font-black uppercase transition-all" id="btn-dirt">Fill</button>
            </div>

            <!-- Stats & Pricing Display -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                    <span class="text-[9px] font-black uppercase text-emerald-700 tracking-wider block mb-1">Area Coverage</span>
                    <div class="flex items-baseline">
                        <span id="area-display" class="text-2xl font-mono font-black text-emerald-900">0.0</span>
                        <span class="text-[10px] font-bold text-emerald-700 ml-1">SQ FT</span>
                    </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <span class="text-[9px] font-black uppercase text-blue-700 tracking-wider block mb-1">Material Needed</span>
                    <div class="flex items-baseline">
                        <span id="volume-display" class="text-2xl font-mono font-black text-blue-900">0.00</span>
                        <span class="text-[10px] font-bold text-blue-700 ml-1">YD³</span>
                    </div>
                </div>
                <div class="col-span-2 bg-slate-900 p-5 rounded-2xl flex justify-between items-center shadow-lg">
                    <div>
                        <span class="text-[9px] font-black uppercase text-slate-400 tracking-widest block mb-1">Project Estimate</span>
                        <span id="cost-display" class="text-3xl font-mono font-black text-white">$0.00</span>
                    </div>
                    <div class="text-right">
                        <span id="depth-label" class="text-emerald-400 font-black text-sm block">3.0" Deep</span>
                        <span id="mat-name-display" class="text-slate-400 text-[9px] uppercase font-bold tracking-widest">Mulch</span>
                    </div>
                </div>
            </div>

            <!-- Sliders -->
            <div class="grid grid-cols-2 gap-6 pt-2">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-gray-400 tracking-tighter">Depth (Inches)</label>
                    <input type="range" id="depth-slider" min="0.5" max="12" step="0.5" value="3" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none accent-green-700">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-gray-400 tracking-tighter block">Price per Yd³</label>
                    <div class="relative">
                        <span class="absolute left-2 top-1.5 text-gray-400 text-xs">$</span>
                        <input type="number" id="price-input" value="45" class="w-full bg-gray-50 border border-gray-200 rounded-lg py-1.5 pl-5 pr-2 font-bold text-sm outline-none focus:border-green-500 transition-colors">
                    </div>
                </div>
            </div>

            <!-- Final Actions -->
            <div class="grid grid-cols-3 gap-3 pb-8">
                <button id="gps-btn" class="bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 flex flex-col items-center justify-center transition-all">
                    <span class="text-xs uppercase">Walk</span>
                    <span class="text-[9px] font-medium opacity-60">Live GPS</span>
                </button>
                <button id="save-btn" class="bg-green-700 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 flex flex-col items-center justify-center transition-all">
                    <span class="text-xs uppercase">Save</span>
                    <span class="text-[9px] font-medium opacity-60">Record</span>
                </button>
                <button id="history-toggle" class="bg-slate-100 border border-slate-200 text-slate-700 font-black py-4 rounded-2xl active:scale-95 flex flex-col items-center justify-center transition-all">
                    <span class="text-xs uppercase">Logs</span>
                    <span class="text-[9px] font-medium opacity-60">History</span>
                </button>
            </div>

            <div id="history-container" class="hidden border-t border-slate-100 pt-4 space-y-3 pb-24">
                <div class="flex justify-between items-center">
                    <h3 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Recent Estimates</h3>
                    <button onclick="localStorage.removeItem('yardstick_jobs'); jobs=[]; renderHistory();" class="text-[9px] text-red-400 uppercase font-bold">Clear All</button>
                </div>
                <div id="history-list" class="history-panel space-y-2"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, polygon, points = [], markers = [];
        let isRecording = false, watchId = null;
        let currentMaterial = "Mulch";
        let jobs = JSON.parse(localStorage.getItem('yardstick_jobs') || '[]');

        function initMap() {
            // Defaulting to Jacksonville, FL
            map = L.map('map', { 
                zoomControl: false,
                attributionControl: false 
            }).setView([30.3322, -81.6557], 18);
            
            // Premium Satellite Layer
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19
            }).addTo(map);

            map.on('click', (e) => addPoint(e.latlng.lat, e.latlng.lng));
            
            // Gentle intro locate
            map.locate({setView: true, maxZoom: 18});
            renderHistory();
        }

        async function searchAddress() {
            const query = document.getElementById('address-input').value;
            const btn = document.getElementById('search-btn');
            if(!query) return;
            
            btn.innerText = "...";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if(data.length > 0) {
                    const { lat, lon } = data[0];
                    map.setView([lat, lon], 19);
                } else {
                    alert("Property not found. Try adding city/state.");
                }
            } catch (e) { alert("Search service busy. Try again."); }
            btn.innerText = "Find";
        }

        function setMaterial(name, depth, price) {
            currentMaterial = name;
            document.getElementById('mat-name-display').innerText = name;
            document.getElementById('depth-slider').value = depth;
            document.getElementById('price-input').value = price;
            document.querySelectorAll('.material-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${name.toLowerCase().split('/')[0]}`).classList.add('active');
            updateShape();
        }

        function addPoint(lat, lng) {
            points.push([lng, lat]);
            const marker = L.circleMarker([lat, lng], {
                radius: 7, fillColor: "#10b981", color: "#fff", weight: 3, opacity: 1, fillOpacity: 1
            }).addTo(map);
            markers.push(marker);
            updateShape();
        }

        function undoLast() {
            if(points.length === 0) return;
            points.pop();
            const lastMarker = markers.pop();
            if(lastMarker) map.removeLayer(lastMarker);
            
            const btn = document.getElementById('undo-btn');
            btn.classList.add('bg-white/40');
            setTimeout(() => btn.classList.remove('bg-white/40'), 200);
            
            updateShape();
        }

        function updateShape() {
            if (polygon) map.removeLayer(polygon);
            
            if (points.length < 3) {
                document.getElementById('area-display').innerText = '0.0';
                document.getElementById('volume-display').innerText = '0.00';
                document.getElementById('cost-display').innerText = '$0.00';
                return;
            }

            const poly = turf.polygon([[...points, points[0]]]);
            const areaSqFt = turf.area(poly) * 10.7639;
            document.getElementById('area-display').innerText = areaSqFt.toLocaleString(undefined, {maximumFractionDigits: 1});

            polygon = L.polygon(points.map(p => [p[1], p[0]]), {
                color: '#10b981', fillColor: '#10b981', fillOpacity: 0.35, weight: 3, dashArray: '8, 8'
            }).addTo(map);

            const depth = document.getElementById('depth-slider').value;
            const price = document.getElementById('price-input').value;
            document.getElementById('depth-label').innerText = depth + '" Deep';
            
            const cubicYards = (areaSqFt * (depth / 12)) / 27;
            const totalCost = cubicYards * price;

            document.getElementById('volume-display').innerText = cubicYards.toFixed(2);
            document.getElementById('cost-display').innerText = '$' + totalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        document.getElementById('search-btn').addEventListener('click', searchAddress);
        document.getElementById('address-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') searchAddress(); });
        document.getElementById('undo-btn').addEventListener('click', undoLast);
        document.getElementById('depth-slider').addEventListener('input', updateShape);
        document.getElementById('price-input').addEventListener('input', updateShape);
        
        document.getElementById('gps-btn').addEventListener('click', function() {
            const btn = this;
            const indicator = document.getElementById('gps-indicator');
            if (!isRecording) {
                isRecording = true;
                btn.classList.replace('bg-blue-600', 'bg-red-600');
                btn.querySelector('span:first-child').innerText = "Stop";
                indicator.classList.replace('bg-red-500', 'bg-green-500');
                indicator.classList.add('animate-pulse');
                watchId = navigator.geolocation.watchPosition((pos) => {
                    if (pos.coords.accuracy < 25) {
                        addPoint(pos.coords.latitude, pos.coords.longitude);
                        map.panTo([pos.coords.latitude, pos.coords.longitude]);
                    }
                }, null, { enableHighAccuracy: true });
            } else {
                isRecording = false;
                btn.classList.replace('bg-red-600', 'bg-blue-600');
                btn.querySelector('span:first-child').innerText = "Walk";
                indicator.classList.replace('bg-green-500', 'bg-red-500');
                indicator.classList.remove('animate-pulse');
                navigator.geolocation.clearWatch(watchId);
            }
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            if (points.length < 3) return alert("Plot an area first!");
            const jobName = prompt("Project Name:", "Client " + (jobs.length + 1));
            if (!jobName) return;
            jobs.unshift({
                id: Date.now(), name: jobName, material: currentMaterial,
                area: document.getElementById('area-display').innerText,
                volume: document.getElementById('volume-display').innerText,
                cost: document.getElementById('cost-display').innerText,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('yardstick_jobs', JSON.stringify(jobs));
            renderHistory();
        });

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = jobs.length === 0 ? '<p class="text-slate-400 text-[10px] italic text-center py-4">No logged estimates found.</p>' : '';
            jobs.forEach(job => {
                const div = document.createElement('div');
                div.className = "p-4 bg-slate-50 border border-slate-100 rounded-2xl flex justify-between items-center active:bg-slate-100 transition-colors";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-black text-slate-800 text-xs truncate w-32">${job.name}</h4>
                            <span class="text-[8px] text-slate-400 font-bold uppercase">${job.date}</span>
                        </div>
                        <p class="text-[10px] text-slate-500 font-medium mt-0.5">${job.material} • ${job.area} ft²</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="text-xs font-black text-blue-600">${job.volume} yd³</span>
                            <span class="text-xs font-black text-green-700">${job.cost}</span>
                        </div>
                    </div>
                    <button onclick="deleteJob(${job.id})" class="ml-4 text-slate-300 active:text-red-500 p-2 text-sm">✕</button>
                `;
                list.appendChild(div);
            });
        }

        window.deleteJob = (id) => {
            jobs = jobs.filter(j => j.id !== id);
            localStorage.setItem('yardstick_jobs', JSON.stringify(jobs));
            renderHistory();
        };

        document.getElementById('history-toggle').addEventListener('click', () => {
            document.getElementById('history-container').classList.toggle('hidden');
        });

        window.onload = initMap;
    </script>
</body>
</html>
